parameters:
- name: 'path'  # defaults for any parameters that aren't specified
  type: string
  default: '$(Build.ArtifactStagingDirectory)\publish'

steps:
- task: EsrpCodeSigning@1
  displayName: 'Code Signing Microsoft code'
  inputs:
    condition: and(succeeded())
    ConnectedServiceName: 'ESRP Official Codesigning'
    FolderPath: ${{ parameters.path }}
    Pattern: |
      dab
      dab.dll
      dab.exe
      Azure.*
      createdump*
      Microsoft.*.dll
      System*.dll
      api-ms*.dll
      mscor*.dll
      msquic.dll
      netstandard.dll
      ucrtbase.dll
      WindowsBase.dll
      aspnetcorev2_inprocess.dll
      clretwrc.dll
      clrjit.dll
      coreclr.dll
      Cosmos.CRTCompat.dll
      hostfxr.dll
      hostpolicy.dll
      liclrjit.*
      libcoreclr*
      libdbgshim.*
      libhostfxr.*
      libhostpolicy.*
      libmscor*
      libSystem*
    signConfigType: 'inlineSignParams'
    inlineOperation: |
      [
          {
            "KeyCode": "CP-230012",
            "OperationCode": "SigntoolSign",
            "Parameters": {
              "OpusName": "Microsoft",
              "OpusInfo": "http://www.microsoft.com",
              "FileDigest": "/fd \"SHA256\"",
              "PageHash": "/NPH",
              "TimeStamp": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
            },
            "ToolName": "sign",
            "ToolVersion": "1.0"
          },
          {
            "KeyCode": "CP-230012",
            "OperationCode": "SigntoolVerify",
            "Parameters": {},
            "ToolName": "sign",
            "ToolVersion": "1.0"
          }
      ]
    SessionTimeout: '60'
    MaxConcurrency: '50'
    MaxRetryAttempts: '5'

- task: EsrpCodeSigning@1
  displayName: 'Code Signing OSS and Third party'
  inputs:
    condition: and(succeeded())
    ConnectedServiceName: 'ESRP Official Codesigning'
    FolderPath: ${{ parameters.path }}
    Pattern: |
      CommandLine.dll
      GreenDonut.dll
      HotChocolate*
      Humanizer*
      MySqlConnector*
      Newtonsoft.Json*
      Npgsql*
    signConfigType: 'inlineSignParams'
    inlineOperation: |
      [
          {
            "KeyCode" : "CP-231522",
            "OperationCode" : "SigntoolSign",
            "Parameters" : {
                "OpusName" : "Microsoft",
                "OpusInfo" : "http://www.microsoft.com",
                "Append" : "/as",
                "FileDigest" : "/fd \"SHA256\"",
                "PageHash" : "/NPH",
                "TimeStamp" : "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
            },
            "ToolName" : "sign",
            "ToolVersion" : "1.0"
        },
        {
            "KeyCode" : "CP-231522",
            "OperationCode" : "SigntoolVerify",
            "Parameters" : {},
            "ToolName" : "sign",
            "ToolVersion" : "1.0"
        }
      ]
    SessionTimeout: '60'
    MaxConcurrency: '50'
    MaxRetryAttempts: '5'