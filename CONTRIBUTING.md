# Contributing

_We are still working on our contribution guidelines. In the meantime, please feel free to open issues and provide feedback on how to streamline the process._

## Introduction

This project welcomes contributions and suggestions. Most contributions require you to agree to a Contributor License Agreement (CLA) declaring that you have the right to, and actually do, grant us the rights to use your contribution. For details, visit https://cla.opensource.microsoft.com.

When you submit a pull request, a CLA bot will automatically determine whether you need to provide a CLA and decorate the PR appropriately (e.g., status check, comment). Simply follow the instructions provided by the bot. You will only need to do this once across all repos using our CLA.

This project has adopted the Microsoft Open Source Code of Conduct. For more information see the Code of Conduct FAQ or contact opencode@microsoft.com with any additional questions or comments.

## Raising Issues

We very much welcome issues to help us improve the project. Please include as much information as possible, including:

- What you were trying to do
- What happened
- What you expected to happen
- Any relevant logs
- The hosting environment (e.g. Local, Azure Static Web Apps, Azure App Service, etc.)

## Working with the code

### Code style

We use `dotnet format` to enforce code conventions. It is run automatically in CI, so if you forget your PR cannot be merged. You can copy paste the
following commands to install a git pre-commit hook. This will cause a commit to fail if you forgot to run `dotnet format`. If you have run on save enabled in your editor this is not necessary.

```bash
cat > .git/hooks/pre-commit << __EOF__
#!/bin/bash
set -euo pipefail

get_files() {
    git diff --cached --name-only --diff-filter=ACMR |\\
        grep '\.cs$'
}

if [ "\$(get_files)" = '' ]; then
    exit 0
fi

get_files |
    xargs dotnet format src/Azure.DataApiBuilder.Service.sln \\
        --check \\
        --fix-whitespace --fix-style warn --fix-analyzers warn \\
        --include \\
    || {
        get_files |
            xargs dotnet format src/Azure.DataApiBuilder.Service.sln \\
                --fix-whitespace --fix-style warn --fix-analyzers warn \\
                --include
        exit 1
}
__EOF__
chmod +x .git/hooks/pre-commit
```

### Testing

All tests are run in CI, so if they fail your PR will not be merged. Running
tests locally can be useful to debug a failure.

#### Running Sql (MsSql, Postgres, MySql) tests

The only thing that should different between CI and your own machine is how you
connect to the database that's used for the tests. You should create a custom
overrides file with your connection string:

- `dab-config.MsSql.overrides.json` for SQL Server
- `dab-config.PostgreSql.overrides.json` for Postgres
- `dab-config.MySql.overrides.json` for MySql

There's a template for these files called:

- `dab-config.MsSql.overrides.example.json` for SQL Server
- `dab-config.PostgreSql.overrides.example.json` for Postgres
- `dab-config.PostgreSql.overrides.example.json` for MySql

If you copy those files to the path without `example` in it and change the
places where it says `REPLACEME` then you should be able to run the tests
locally using the following commands:

- `dotnet test --filter "TestCategory=MsSql"` for SQL Server
- `dotnet test --filter "TestCategory=PostgreSql"` for Postgres
- `dotnet test --filter "TestCategory=MySql"` for MySql

### Running CosmosDB tests

TODO

### Running unit tests

TODO

### Modifying tests

Some tests have generated SQL in them. To make those queries readable we have
first put them through a SQL formatter. When adding other autogenerated queries
or modifying existing ones, please use the same SQL formatter. That way diffs in
these queries stay minimal:

- For Postgres use https://sqlformat.org/. Then after formatting make sure to
  remove all unnecessary double quotes, because otherwise you have to escape
  them in the multiline string.
- For SQL Server use https://poorsql.com/. Edit the default formatter settings
  by checking the "trailing commas" checkbox, and adding `\s\s\s\s` in the "indent string box".
- For MySql use https://poorsql.com/ with the same configuration as SQL Server (above) and set
  the max line width to 100.
