# Testing Semantic Cache with Real Azure OpenAI

This guide explains how to test your semantic caching implementation with actual Azure OpenAI embeddings instead of mock data.

## üîç Current Test Modes

### Mock Mode (Default)
- **Endpoint**: `https://test.openai.azure.com` (fake)
- **API Key**: `test-key` (fake)  
- **Embeddings**: Generated using `Random(42)` - completely fake vectors
- **Purpose**: Unit testing without external dependencies

### Real Azure OpenAI Mode
- **Endpoint**: Your actual Azure OpenAI resource endpoint
- **API Key**: Real API key from your Azure OpenAI resource
- **Embeddings**: Real vectors generated by Azure OpenAI embedding models
- **Purpose**: Integration testing with actual Azure services

## üöÄ Setting Up Real Azure OpenAI Testing

### Prerequisites

1. **Azure OpenAI Resource**: You need an Azure OpenAI resource deployed
2. **Embedding Model**: Deploy an embedding model (e.g., `text-embedding-ada-002`)
3. **API Access**: Get your endpoint and API key

### Environment Variables Setup

```bash
# Required for real Azure OpenAI testing
export AZURE_OPENAI_ENDPOINT="https://your-resource-name.openai.azure.com"
export AZURE_OPENAI_API_KEY="your-api-key-here"
export AZURE_OPENAI_EMBEDDING_MODEL="text-embedding-ada-002"  # Optional, defaults to text-embedding-ada-002

# Enable real Azure OpenAI tests
export ENABLE_REAL_AZURE_OPENAI_TESTS=true
```

### Finding Your Azure OpenAI Details

#### Option 1: Azure Portal
1. Go to [Azure Portal](https://portal.azure.com)
2. Navigate to your Azure OpenAI resource
3. Go to "Keys and Endpoint" section
4. Copy the endpoint and one of the keys

#### Option 2: Azure CLI
```bash
# Get Azure OpenAI resource details
az cognitiveservices account show \
  --name "your-openai-resource-name" \
  --resource-group "your-resource-group" \
  --query "{endpoint:properties.endpoint}"

# Get API keys
az cognitiveservices account keys list \
  --name "your-openai-resource-name" \
  --resource-group "your-resource-group"
```

## üß™ Running Tests with Real Azure OpenAI

### Run Mock Tests (Default)
```bash
cd src/Service.Tests
dotnet test --filter "FullyQualifiedName~SemanticCacheIntegrationTests" --logger:console;verbosity=detailed
```

### Run Real Azure OpenAI Tests
```bash
# Set environment variables first
export ENABLE_REAL_AZURE_OPENAI_TESTS=true
export AZURE_OPENAI_ENDPOINT="https://your-resource.openai.azure.com"
export AZURE_OPENAI_API_KEY="your-api-key"

# Run the specific real Azure OpenAI test
dotnet test --filter "FullyQualifiedName~TestSemanticCacheConfiguration_WithRealAzureOpenAI" --logger:console;verbosity=detailed
```

## üîê Security Best Practices

Following Azure security best practices, the implementation:

‚úÖ **Never hardcodes credentials** - All sensitive data comes from environment variables
‚úÖ **Supports credential rotation** - Simply update environment variables  
‚úÖ **Uses least privilege** - Only requires the specific embedding endpoint access
‚úÖ **Enables secure connections** - Uses HTTPS endpoints
‚úÖ **Masks credentials in logs** - API keys are partially hidden in test output

## üí∞ Cost Considerations

**Mock Testing**: Free - no external calls
**Real Azure OpenAI Testing**: Costs money - each embedding generation call is billed

Typical costs:
- `text-embedding-ada-002`: ~$0.0001 per 1K tokens
- Test queries are usually small, so cost is minimal for testing

## üîç Verifying Real Embeddings

When using real Azure OpenAI, you can verify embeddings are working by:

1. **Checking test output** - Look for real endpoint URLs in console
2. **Monitoring Azure OpenAI** - Check usage in Azure portal
3. **Vector inspection** - Real embeddings will have different patterns than mock ones

## üêõ Troubleshooting

### Test Skipped
```
Assert.Inconclusive: Set ENABLE_REAL_AZURE_OPENAI_TESTS=true...
```
**Solution**: Set the environment variable `ENABLE_REAL_AZURE_OPENAI_TESTS=true`

### Missing Environment Variables
```
InvalidOperationException: AZURE_OPENAI_ENDPOINT environment variable is required
```
**Solution**: Set all required environment variables listed above

### Authentication Errors
```
HTTP 401 Unauthorized
```
**Solution**: Verify your API key is correct and the resource is accessible

### Model Not Found
```
HTTP 404 Not Found
```
**Solution**: Ensure you've deployed an embedding model to your Azure OpenAI resource

## üéØ Next Steps

1. **Start with mock tests** - Ensure your logic works
2. **Set up Azure OpenAI resource** - Deploy if you don't have one
3. **Configure environment variables** - Add real credentials
4. **Run real tests** - Verify embeddings are generated correctly
5. **Monitor costs** - Keep an eye on Azure OpenAI usage