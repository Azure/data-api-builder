# Data API builder `0.12.0` (release candidate 1) Bug Bash

## Overview

We'll focus on net-new features and newly introduced bug fixes to drive our bug bashing session.
Primarily, well focus on MSSQL (Azure SQL/ SQL Server) scenarios. 

## Pre-Requisites

1. Install latest versions of .NET 6.0 SDK -> `6.0.421` from https://dotnet.microsoft.com/en-us/download/dotnet/6.0

```powershell
winget install Microsoft.DotNet.SDK.6
```
1. SQL Server Environment where any of the following will suffice
  1. SQL Server 2022 - Windows
  1. Docker (SQL Server 2022 - Linux)
    ```powershell
    docker pull mcr.microsoft.com/mssql/server:2022-latest
    docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=<YourStrong@Passw0rd>" -p 1433:1433 --name sql1 --hostname sql1 -d mcr.microsoft.com/mssql/server:2022-latest
    ```
  1. Azure SQL
1. Create a database for this bug bash that doesn't conflict with any pre-existing work: `dab-bugbash-april`
    1. Populate database with contents of https://github.com/Azure/data-api-builder/blob/release/0.12/src/Service.Tests/DatabaseSchema-MsSql.sql

## Scenarios - New Features

### Relationship Validation
Using the config from our test project: https://github.com/Azure/data-api-builder/blob/main/src/Service.Tests/dab-config.MsSql.json
- Replace with your connection string.

1. Modify the relationship config of entity `BookNF` (line 2965) such that number of linking source/target fields don't match:
  1. Run dab with the modified config to see console errors reported.
  1. Run `dab validate --config "fullPath" to see errors reported
1. Modify the relationship config of the entity `Publisher` (line 265) to change the values (or lackthereof) of the `source.fields` and `target.fields` properties:
   ```json
    "relationships": {
        "books": {
          "cardinality": "many",
          "target.entity": "Book",
          "source.fields": [],
          "target.fields": []
        }
   ```
  1. The point of this test is to get DAB to emit validation errors. So a
    - adding a mismatching number of fields to source/target will result in errors.
    - adding invalid field names to source/target will result in errors
    - Removing the foreign key in the database should result in the above config erroring out unless you supply a matching number of source/target fields.
   

### Pagination limits

Using new global config property within the `runtime` section:
```json
{
  "runtime": {
    "pagination": {
      "default-page-size": -1,
      "max-page-size": 1233
    }
  }
}
```

Using an entity which has many db records, e.g. `Bookmarks` Attempt to find unexpected results when modifying the properties above. 
- `-1` means "use max-page-size value."

Test pagination by using sample queries from [Pagination endcursor tests](#graphql--rest-pagination-endcursor-and-hasnextpage-content-validation)

### DAB Health Endpoint Metadata

View new metadata at root of DAB instance
```https
https://localhost:5001/
```

you should see something like:
```json
{
    "status": "Healthy",
    "version": "0.12.0",
    "app-name": "dab_oss_0.12.0"
}
```

## Scenarios - Fixed bugs

### `dab validate` CLI usage
#### Entity.Source.Object not defined in database
Using the entity configuration for `Bookmarks`:
<details>
  <summary>Entity config for dab-config.json</summary>

```json
    "Bookmarks": {
      "source": {
        "object": "not_a_real_table",
        "type": "table"
      },
      "graphql": {
        "enabled": true,
        "type": {
          "singular": "Bookmarks",
          "plural": "Bookmarks"
        }
      },
      "rest": {
        "enabled": true
      },
      "permissions": [
        {
          "role": "anonymous",
          "actions": [
            {
              "action": "*"
            }
          ]
        },
        {
          "role": "authenticated",
          "actions": [
            {
              "action": "*"
            }
          ]
        }
      ]
    }
```
</details>

run the following dab cli command using the new file:

`dab validate --config "FullPathToConfig"` on this new config (replace pathname to represent your local setup) to ensure there are no hangs or unexpected errors.

### GraphQL && REST pagination `endCursor` and `hasNextPage` content validation

#### REST
Use the following request to paginate over entity records.
The first request should return a default of 100 records unless you are using the new feature properties of "Pagination limits"
```https
https://localhost:5001/api/Bookmarks
```

Paginate by using URL provided by `nextLink` json property in response
```https
https://localhost:5001/api/Bookmarks?$after=W3siRW50aXR5TmFtZSI6IkJvb2ttYXJrcyIsIkZpZWxkTmFtZSI6ImlkIiwiRmllbGRWYWx1ZSI6MTAwLCJEaXJlY3Rpb24iOjB9XQ==
```

#### GraphQL

Use the following query to paginate over entity records:

```graphql
query paginationBugBash {
 bookmarks(first: 5)
 {
  items{
    id
    bkname
  }
  endCursor
  hasNextPage
 }
}
```

Then you can use the endcursor value to paginate:

```graphql
query paginationBugBashPage {
 bookmarks(first: 5 after: "W3siRW50aXR5TmFtZSI6IkJvb2ttYXJrcyIsIkZpZWxkTmFtZSI6ImlkIiwiRmllbGRWYWx1ZSI6NSwiRGlyZWN0aW9uIjowfV0=" )
 {
  items{
    id
    bkname
  }
  endCursor
  hasNextPage
 }
}
```
