// Copyright (c) Microsoft Corporation.
// Licensed under the MIT License.

using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Net;
using System.Text;
using System.Text.Json;
using Azure.DataApiBuilder.Auth;
using Azure.DataApiBuilder.Config;
using Azure.DataApiBuilder.Service.Configurations;
using Azure.DataApiBuilder.Service.Exceptions;
using Microsoft.OpenApi.Models;
using Microsoft.OpenApi.Writers;
using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace Azure.DataApiBuilder.Service.Services
{
    public class OpenApiDocumentor : IOpenApiDocumentor
    {
        private ISqlMetadataProvider _metadataProvider;
        private IAuthorizationResolver _authorizationResolver;
        private OpenApiDocument? _openApiDocument;
        private RuntimeConfig _runtimeConfig;

        public OpenApiDocumentor(ISqlMetadataProvider sqlMetadataProvider, IAuthorizationResolver authorizationResolver, RuntimeConfigProvider runtimeConfigProvider)
        {
            _metadataProvider = sqlMetadataProvider;
            _authorizationResolver = authorizationResolver;
            _openApiDocument = null;
            _runtimeConfig = runtimeConfigProvider.GetRuntimeConfiguration();
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="document"></param>
        /// <returns></returns>
        public bool TryGetDocument([NotNullWhen(true)] out string? document)
        {
            if (_openApiDocument is null)
            {
                document = null;
                return false;
            }

            using (StringWriter textWriter = new(CultureInfo.InvariantCulture))
            {
                OpenApiJsonWriter jsonWriter = new(textWriter);
                _openApiDocument.SerializeAsV3(jsonWriter);

                string jsonPayload = textWriter.ToString();
                document = jsonPayload;
                return true;
            }
        }

        public void CreateDocument()
        {
            if (_openApiDocument is not null)
            {
                throw new DataApiBuilderException(
                    message: "OpenAPI description document already generated.",
                    statusCode: HttpStatusCode.Conflict,
                    subStatusCode: DataApiBuilderException.SubStatusCodes.OpenApiDocumentAlreadyExists);
            }

            try
            {
                OpenApiDocument doc = new()
                {
                    Info = new OpenApiInfo
                    {
                        Version = "0.0.1",
                        Title = "Data API builder - OpenAPI Description Document",
                    },
                    Servers = new List<OpenApiServer>
                {
                    new OpenApiServer { Url = "https://localhost:5000/api/openapi" }
                },
                    Paths = BuildPaths(),
                    Components = BuildComponents()
                };
                _openApiDocument = doc;
            }
            catch(Exception ex)
            {
                throw new DataApiBuilderException(
                    message: "OpenAPI description document generation failed.",
                    statusCode: HttpStatusCode.InternalServerError,
                    subStatusCode: DataApiBuilderException.SubStatusCodes.OpenApiDocumentGenerationFailure,
                    innerException: ex);
            }

        }

        public OpenApiPaths BuildPaths()
        {
            // iterate through entities
            // BuildPath on entity (which includes Generating Parameters)
            // Generate Operations (which include Generating Responses)
            OpenApiPaths pathsCollection = new();
            foreach (string entityName in _metadataProvider.EntityToDatabaseObject.Keys.ToList())
            {
                // First tuple returned is path which includes PK in route (GET (by ID), PUT, PATCH, DELETE
                // and POST when PK is not autogenerated
                Tuple<string, OpenApiPathItem> path = BuildPath(entityName);
                pathsCollection.Add(path.Item1, path.Item2);
                // Second tuple returned  for GET (all) and POST when PK is autogenerated.
                Tuple<string, OpenApiPathItem> pathGetAllPost = BuildGetAllAndPostPath(entityName);
                pathsCollection.TryAdd(pathGetAllPost.Item1, pathGetAllPost.Item2);
            }

            return pathsCollection;
        }

        public Tuple<string, OpenApiPathItem> BuildGetAllAndPostPath(string entityName)
        {
            string entityRestPath = GetEntityRestPath(entityName);

            string entityBasePathComponent = $"/{entityRestPath}";
            Assert.IsFalse(entityBasePathComponent == "/");

            // Can a composite primary key have mix of auto/non-autogen'd fields? 
            SourceDefinition sourceDefinition = _metadataProvider.GetSourceDefinition(entityName);
            // Parameters are the placeholders for pk values in curly braces { } in the URL route
            // localhost:5000/api/Entity/pk1/{pk1}/pk2/{pk2}
            bool sourceObjectHasAutogeneratedPK = false;
            bool requestBodyRequired = IsRequestBodyRequired(sourceDefinition);

            List<OpenApiTag> tags = new()
            {
                // Explicitly leave out description which can note the actual entity name when
                                // a REST path override is used because it may not be desired to expose that name.
                new OpenApiTag()
                {
                    Name = entityRestPath
                }
            };

            Assert.IsFalse(string.IsNullOrEmpty(entityBasePathComponent));
            // /{entityName/RestPathName} + {/pk/{pkValue}} * N
            // CreateFullPathComponentAndParameters()
            return new Tuple<string, OpenApiPathItem>(
                entityBasePathComponent,
                new OpenApiPathItem()
                {
                    Operations = new Dictionary<OperationType, OpenApiOperation>()
                    {
                        // Creation GET, POST, PUT, PATCH, DELETE operations
                        [OperationType.Get] = new OpenApiOperation()
                        {
                            Description = "Returns entities.",
                            Tags = tags,
                            Responses = new OpenApiResponses()
                            {
                                ["200"] = CreateResponse(description: "OK", responseObjectSchemaName: entityName),
                                ["400"] = CreateResponse(description: "Bad Request"),
                                ["401"] = CreateResponse(description: "Unauthorized"),
                                ["403"] = CreateResponse(description: "Forbidden"),
                                ["404"] = CreateResponse(description: "Not Found")
                            }
                        },
                        [OperationType.Post] = new OpenApiOperation()
                        {
                            Description = "Create entity.",
                            Tags = tags,
                            Responses = new OpenApiResponses()
                            {
                                ["201"] = CreateResponse(description: "Created", responseObjectSchemaName: entityName),
                                ["400"] = CreateResponse(description: "Bad Request"),
                                ["401"] = CreateResponse(description: "Unauthorized"),
                                ["403"] = CreateResponse(description: "Forbidden"),
                                ["404"] = CreateResponse(description: "Not Found"),
                                ["409"] = CreateResponse(description: "Conflict")
                            },
                            RequestBody = new OpenApiRequestBody()
                            {
                                Content = new Dictionary<string, OpenApiMediaType>()
                                {
                                    {
                                        "application/json",
                                        new()
                                        {
                                            Schema = new OpenApiSchema()
                                            {
                                                // when a post request on entity with PK autogenerated, do not allow pk in post body.
                                                Reference = new OpenApiReference()
                                                {
                                                    Type = ReferenceType.Schema,
                                                    Id = sourceObjectHasAutogeneratedPK ? $"{entityName}_NoPK" : $"{entityName}"
                                                }
                                            }
                                        }
                                    }
                                },
                                // This should be conditioned on whether the table's columns either
                                // autogenerated
                                // nullable
                                // hasDefaultValue
                                Required = requestBodyRequired
                            }
                        }
                    }
                }
            );
        }

        /// <summary>
        /// Includes Path with Operations(+responses) and Parameters
        /// </summary>
        /// <returns></returns>
        public Tuple<string, OpenApiPathItem> BuildPath(string entityName)
        {
            string entityRestPath = GetEntityRestPath(entityName);

            string entityBasePathComponent = $"/{entityRestPath}";
            Assert.IsFalse(entityBasePathComponent == "/");

            // Can a composite primary key have mix of auto/non-autogen'd fields? 
            SourceDefinition sourceDefinition = _metadataProvider.GetSourceDefinition(entityName);
            StringBuilder pkComponents = new();
            // Parameters are the placeholders for pk values in curly braces { } in the URL route
            // localhost:5000/api/Entity/pk1/{pk1}/pk2/{pk2}
            List<OpenApiParameter> parameters = new();
            bool sourceObjectHasAutogeneratedPK = false;
            bool requestBodyRequired = IsRequestBodyRequired(sourceDefinition);

            foreach (string column in sourceDefinition.PrimaryKey)
            {
                string columnNameForComponent = column;

                if (sourceDefinition.Columns.TryGetValue(columnNameForComponent, out ColumnDefinition? columnDef) && columnDef is not null && columnDef.IsAutoGenerated)
                {
                    sourceObjectHasAutogeneratedPK = true;
                }

                if (_metadataProvider.TryGetExposedColumnName(entityName, column, out string? mappedColumnAlias) && !string.IsNullOrEmpty(mappedColumnAlias))
                {
                    columnNameForComponent = mappedColumnAlias;
                }

                parameters.Add(new OpenApiParameter()
                {
                    Required = true,
                    In = ParameterLocation.Path,
                    Name = $"{columnNameForComponent}",
                    Schema = new OpenApiSchema()
                    {
                        Type = (columnDef is not null) ? SystemTypeToJsonValueKind(columnDef.SystemType).ToString().ToLower() : string.Empty
                    }
                });
                string pkComponent = $"/{columnNameForComponent}/{{{columnNameForComponent}}}";
                pkComponents.Append(pkComponent);
            }

            List<OpenApiTag> tags = new()
            {
                // Explicitly leave out description which can note the actual entity name when
                                // a REST path override is used because it may not be desired to expose that name.
                new OpenApiTag()
                {
                    Name = entityRestPath
                }
            };

            Assert.IsFalse(string.IsNullOrEmpty(entityBasePathComponent));
            // /{entityName/RestPathName} + {/pk/{pkValue}} * N
            // CreateFullPathComponentAndParameters()
            return new Tuple<string, OpenApiPathItem>(
                entityBasePathComponent + pkComponents.ToString(),
                new OpenApiPathItem()
                {
                    Operations = new Dictionary<OperationType, OpenApiOperation>()
                    {
                        // Creation GET, POST, PUT, PATCH, DELETE operations
                        [OperationType.Get] = new OpenApiOperation()
                        {
                            Description = "Returns an entity.",
                            Tags = tags,
                            Responses = new OpenApiResponses()
                            {
                                ["200"] = CreateResponse(description: "OK", responseObjectSchemaName: entityName),
                                ["400"] = CreateResponse(description: "Bad Request"),
                                ["401"] = CreateResponse(description: "Unauthorized"),
                                ["403"] = CreateResponse(description: "Forbidden"),
                                ["404"] = CreateResponse(description: "Not Found")
                            }
                        },
                        [OperationType.Put] = new OpenApiOperation()
                        {
                            Description = "Replace or Create entity/entities.",
                            Tags = tags,
                            Responses = new OpenApiResponses()
                            {
                                ["200"] = CreateResponse(description: "OK", responseObjectSchemaName: entityName),
                                ["201"] = CreateResponse(description: "Created", responseObjectSchemaName: entityName),
                                ["400"] = CreateResponse(description: "Bad Request"),
                                ["401"] = CreateResponse(description: "Unauthorized"),
                                ["403"] = CreateResponse(description: "Forbidden"),
                                ["404"] = CreateResponse(description: "Not Found")
                            },
                            RequestBody = new OpenApiRequestBody()
                            {
                                Content = new Dictionary<string, OpenApiMediaType>()
                                {
                                    {
                                        "application/json",
                                        new()
                                        {
                                            Schema = new OpenApiSchema()
                                            {
                                                // when a post request on entity with PK autogenerated, do not allow pk in post body.
                                                Reference = new OpenApiReference()
                                                {
                                                    Type = ReferenceType.Schema,
                                                    Id = sourceObjectHasAutogeneratedPK ? $"{entityName}_NoPK" : $"{entityName}"
                                                }
                                            }
                                        }
                                    }
                                },
                                // This should be conditioned on whether the table's columns either
                                // autogenerated
                                // nullable
                                // hasDefaultValue
                                Required = requestBodyRequired
                            }
                        },
                        [OperationType.Patch] = new OpenApiOperation()
                        {
                            Description = "Update or Create entity/entities.",
                            Tags = tags,
                            Responses = new OpenApiResponses()
                            {
                                ["200"] = CreateResponse(description: "OK", responseObjectSchemaName: entityName),
                                ["201"] = CreateResponse(description: "Created", responseObjectSchemaName: entityName),
                                ["400"] = CreateResponse(description: "Bad Request"),
                                ["401"] = CreateResponse(description: "Unauthorized"),
                                ["403"] = CreateResponse(description: "Forbidden"),
                                ["404"] = CreateResponse(description: "Not Found")
                            },
                            RequestBody = new OpenApiRequestBody()
                            {
                                Content = new Dictionary<string, OpenApiMediaType>()
                                {
                                    {
                                        "application/json",
                                        new()
                                        {
                                            Schema = new OpenApiSchema()
                                            {
                                                // when a post request on entity with PK autogenerated, do not allow pk in post body.
                                                Reference = new OpenApiReference()
                                                {
                                                    Type = ReferenceType.Schema,
                                                    Id = sourceObjectHasAutogeneratedPK ? $"{entityName}_NoPK" : $"{entityName}"
                                                }
                                            }
                                        }
                                    }
                                },
                                // This should be conditioned on whether the table's columns either
                                // autogenerated
                                // nullable
                                // hasDefaultValue
                                Required = requestBodyRequired
                            }
                        },
                        [OperationType.Delete] = new OpenApiOperation()
                        {
                            Description = "Delete entity/entities.",
                            Tags = tags,
                            Responses = new OpenApiResponses()
                            {
                                ["200"] = CreateResponse(description: "OK", responseObjectSchemaName: entityName),
                                ["204"] = CreateResponse(description: "No Content", responseObjectSchemaName: entityName),
                                ["400"] = CreateResponse(description: "Bad Request"),
                                ["401"] = CreateResponse(description: "Unauthorized"),
                                ["403"] = CreateResponse(description: "Forbidden"),
                                ["404"] = CreateResponse(description: "Not Found")
                            }
                        }
                    },
                    Parameters = parameters
                }
            );
        }

        /// <summary>
        /// Evaluates a table's columns to determine whethere 
        /// </summary>
        /// <param name="sourceDef"></param>
        /// <returns></returns>
        public bool IsRequestBodyRequired(SourceDefinition sourceDef)
        {
            foreach (KeyValuePair<string, ColumnDefinition> columnMetadata in sourceDef.Columns)
            {
                // Primary Key Check -> Body shouldn't have primary key if it is autogenerated. 
                if (sourceDef.PrimaryKey.Contains(columnMetadata.Key) && columnMetadata.Value.IsAutoGenerated)
                {
                    continue;
                }

                // The presence of a non-PK column which does not have any of the following properties
                // results in the body being required.
                if (columnMetadata.Value.HasDefault || columnMetadata.Value.IsNullable || columnMetadata.Value.IsAutoGenerated)
                {
                    continue;
                }

                return false;
            }

            return true;
        }

        /// <summary>
        /// Resolves any REST path overrides present for the provided entity in the runtime config.
        /// If no overrides exist, returns the passed in entity name.
        /// </summary>
        /// <param name="entityName">Name of the entity.</param>
        /// <returns>Returns the REST path name for the provided entity.</returns>
        public string GetEntityRestPath(string entityName)
        {
            object? entityRestSettings = _runtimeConfig.Entities[entityName].GetRestEnabledOrPathSettings();
            string entityRestPath = entityName;
            if (entityRestSettings is not null && entityRestSettings is string)
            {
                entityRestPath = (string)entityRestSettings;
                if (!string.IsNullOrEmpty(entityRestPath) && entityRestPath.StartsWith('/'))
                {
                    // Remove slash from start of rest path.
                    entityRestPath = entityRestPath.Substring(1);
                }
            }

            Assert.IsFalse(string.Equals('/', entityRestPath));
            return entityRestPath;
        }

        public OpenApiComponents BuildComponents()
        {
            return new OpenApiComponents()
            {
                Schemas = BuildComponentSchemas()
            };
        }

        public OpenApiResponse CreateResponse(string description, string? responseObjectSchemaName = null)
        {
            OpenApiResponse response = new()
            {
                Description = description
            };

            // No entityname means there no example response object schema should be included.
            // the entityname references the schema of the response object.
            if (!string.IsNullOrEmpty(responseObjectSchemaName))
            {
                response.Content = new Dictionary<string, OpenApiMediaType>()
                {
                    {
                        "application/json",
                        new()
                        {
                            Schema = new OpenApiSchema()
                            {
                                Properties = new Dictionary<string, OpenApiSchema>()
                                            {
                                                {
                                                    "value",
                                                    new OpenApiSchema()
                                                    {
                                                        Type = "array",
                                                        Items = new OpenApiSchema()
                                                        {
                                                            Reference = new OpenApiReference()
                                                            {
                                                                Type = ReferenceType.Schema,
                                                                Id = $"{responseObjectSchemaName}"
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                            }
                        }
                    }
                };
            }

            return response;
        }

        public OpenApiMediaType GetResponsePayload(string entityName)
        {
            OpenApiMediaType responsePayload = new()
            {
                Schema = new OpenApiSchema()
                {
                    Properties = new Dictionary<string, OpenApiSchema>()
                                {
                                    {
                                        "value",
                                        new OpenApiSchema()
                                        {
                                            Type = "array",
                                            Items = new OpenApiSchema()
                                            {
                                                Reference = new OpenApiReference()
                                                {
                                                    Type = ReferenceType.Schema,
                                                    Id = $"{entityName}"
                                                }
                                            }
                                        }
                                    }
                                }
                }
            };

            return responsePayload;
        }

        public Dictionary<string, OpenApiSchema> BuildComponentSchemas()
        {
            Dictionary<string, OpenApiSchema> schemas = new();

            foreach (string entityName in _metadataProvider.EntityToDatabaseObject.Keys.ToList())
            {
                SourceDefinition sourceDefinition = _metadataProvider.GetSourceDefinition(entityName);
                List<string> columns = /*sourceDefinition is null ? new List<string>() : */sourceDefinition.Columns.Keys.ToList();

                // create component for FULL entity with PK.
                schemas.Add(entityName, CreateComponentSchema(entityName, fields: columns));

                // create component for entity with no PK
                // get list of columns - primary key columns then optimize

                foreach (string primaryKeyColumn in sourceDefinition.PrimaryKey)
                {
                    columns.Remove(primaryKeyColumn);
                }

                // create component for TABLE (view?) NOT STOREDPROC entity with no PK.
                DatabaseObject dbo = _metadataProvider.EntityToDatabaseObject[entityName];
                if (dbo.SourceType is not SourceType.StoredProcedure or SourceType.View)
                {
                    schemas.Add($"{entityName}_NoPK", CreateComponentSchema(entityName, fields: columns));
                }
            }

            return schemas;
        }

        /// <summary>
        /// Input needs entity fields and field data type metadata
        /// Should this have conditional for creating component with PK field? or should that be handled before
        /// and only pass in a field list here to generalize?
        /// ex
        /// </summary>
        /// <param name="entityName">Name of the entity.</param>
        /// <param name="fields">List of mapped (alias) field names.</param>
        /// <returns></returns>
        public OpenApiSchema CreateComponentSchema(string entityName, List<string> fields)
        {
            if (!_metadataProvider.EntityToDatabaseObject.TryGetValue(entityName, out DatabaseObject? dbObject) || dbObject is null)
            {
                throw new DataApiBuilderException(message: "oops bad entity", statusCode: System.Net.HttpStatusCode.InternalServerError, subStatusCode: DataApiBuilderException.SubStatusCodes.OpenApiDocumentAlreadyExists);
            }

            Dictionary<string, OpenApiSchema> properties = new();            
            foreach (string field in fields)
            {
                if (_metadataProvider.TryGetBackingColumn(entityName, field, out string? backingColumnValue) && !string.IsNullOrEmpty(backingColumnValue))
                {
                    string typeMetadata = string.Empty;
                    string formatMetadata = string.Empty;
                    if (dbObject.SourceDefinition.Columns.TryGetValue(backingColumnValue, out ColumnDefinition? columnDef) && columnDef is not null)
                    {
                        typeMetadata = SystemTypeToJsonValueKind(columnDef.SystemType).ToString().ToLower();
                    }

                    properties.Add(field, new OpenApiSchema()
                    {
                        Type = typeMetadata,
                        Format = formatMetadata
                    });
                }
            }

            OpenApiSchema schema = new()
            {
                Type = "object",
                Properties = properties
            };

            return schema;
        }

        public JsonValueKind SystemTypeToJsonValueKind(Type type)
        {
            return type.Name switch
            {
                "String" => JsonValueKind.String,
                "Guid" => JsonValueKind.String,
                "Byte" => JsonValueKind.String,
                "Int16" => JsonValueKind.Number,
                "Int32" => JsonValueKind.Number,
                "Int64" => JsonValueKind.Number,
                "Single" => JsonValueKind.Number,
                "Double" => JsonValueKind.Number,
                "Decimal" => JsonValueKind.Number,
                "Boolean" => JsonValueKind.True,
                "DateTime" => JsonValueKind.String,
                "DateTimeOffset" => JsonValueKind.String,
                "Byte[]" => JsonValueKind.String,
                _ => throw new DataApiBuilderException(
                        message: $"Column type {type} not handled by case. Please add a case resolving {type} to the appropriate GraphQL type",
                        statusCode: HttpStatusCode.InternalServerError,
                        subStatusCode: DataApiBuilderException.SubStatusCodes.GraphQLMapping)
            };
        }

        /// <summary>
        /// Returns schema object representing an Entity's non-primary key fields. 
        /// </summary>
        /// <returns></returns>
        public OpenApiSchema EntityToSchemaObject()
        {
            return new OpenApiSchema();
        }

        /// <summary>
        /// Returns schema object representing Entity including primary key and non-primary key fields.
        /// </summary>
        /// <returns></returns>
        public OpenApiSchema FullEntityToSchemaObject()
        {
            return new OpenApiSchema();
        }

        /// <summary>
        /// Returns collection representing an entity's field metadata
        /// Key: field name
        /// Value: OpenApiSchema describing the (value) Type and (value) Format of the field.
        /// </summary>
        /// <returns></returns>
        public Dictionary<string, OpenApiSchema> BuildComponentProperties()
        {
            Dictionary<string, OpenApiSchema> fieldMetadata = new();
            return fieldMetadata;
        }
    }
}
